# 网关限流功能说明

## 功能概述

网关限流功能采用令牌桶算法，提供三层防护：

1. **全局限流**：控制整个网关的总体请求流量
2. **服务限流**：控制单个后端服务的请求流量  
3. **玩家限流**：防止单个玩家恶意刷请求

## 配置说明

在 `config.yaml` 中添加限流配置：

```yaml
# 限流配置
rate_limit:
  # 是否启用限流保护
  enabled: true
  # 全局限流配置（整个网关）
  global_rate: 500        # 全局每秒最大请求数
  global_capacity: 1000   # 全局令牌桶容量
  # 服务级限流配置（单个服务）
  service_rate: 100       # 单服务每秒最大请求数
  service_capacity: 200   # 单服务令牌桶容量
  # 玩家级限流配置（防止单玩家恶意请求）
  player_rate: 10         # 单玩家每秒最大请求数
  player_capacity: 20     # 单玩家令牌桶容量
  # 清理配置
  cleanup_interval_min: 1 # 令牌桶清理间隔（分钟）
  bucket_idle_time_min: 5 # 令牌桶空闲超时时间（分钟）
```

## 限流策略

### 令牌桶算法原理

1. **令牌生成**：按配置的速率向桶中添加令牌
2. **令牌消费**：每个请求消费1个令牌
3. **突发支持**：桶容量支持一定的突发流量
4. **阻断保护**：令牌不足时拒绝请求

### 三层限流检查

请求按以下顺序进行限流检查：

1. **全局限流** → 2. **服务限流** → 3. **玩家限流**

任何一层检查失败都会返回 `429 Too Many Requests` 错误。

## 监控接口

限流监控服务默认运行在 `:8081` 端口，提供以下接口：

### 1. 限流状态查询

```bash
# 基本状态
GET http://localhost:8081/rate-limit/status

# 详细状态（包含所有服务和玩家统计）
GET http://localhost:8081/rate-limit/status?detail=true
```

响应示例：
```json
{
  "enabled": true,
  "global_tokens": 850,
  "global_capacity": 1000,
  "global_rate": 500,
  "service_buckets": 3,
  "player_buckets": 15,
  "service_stats": {
    "userservice": {
      "tokens": 180,
      "capacity": 200,
      "rate": 100,
      "last_used": 1703123456789
    }
  },
  "player_stats": {
    "player123": {
      "tokens": 18,
      "capacity": 20,
      "rate": 10,
      "last_used": 1703123456789
    }
  },
  "timestamp": 1703123456789,
  "config": {
    "enabled": true,
    "global_rate": 500,
    "global_capacity": 1000
  }
}
```

### 2. 配置查询

```bash
GET http://localhost:8081/rate-limit/config
```

### 3. 重置限流

```bash
# 重置特定服务的限流
POST http://localhost:8081/rate-limit/reset/service?service=userservice

# 重置特定玩家的限流
POST http://localhost:8081/rate-limit/reset/player?player=player123
```

### 4. 健康检查

```bash
GET http://localhost:8081/health
```

## 限流日志

当请求被限流时，系统会记录详细日志：

```
[限流拒绝] 全局限流，当前令牌: 0
[限流拒绝] 服务限流 userservice，当前令牌: 0  
[限流拒绝] 玩家限流 player123，当前令牌: 0
[限流] 拒绝请求 - 服务: userservice, 玩家: player123, 原因: 请求过于频繁，请稍后重试
```

正常情况下的日志：
```
[限流器] 启动成功 - 全局: 500/1000, 服务: 100/200, 玩家: 10/20
[限流] 创建服务令牌桶: userservice, 容量: 200, 速率: 100/s
[限流] 创建玩家令牌桶: player123, 容量: 20, 速率: 10/s
[限流清理] 清理服务令牌桶: oldservice
[限流清理] 清理玩家令牌桶: oldplayer
```

## 性能影响

1. **内存开销**：每个活跃服务和玩家会创建一个令牌桶（约100字节）
2. **CPU开销**：每次请求需要进行3次令牌桶检查（微秒级别）  
3. **自动清理**：空闲的令牌桶会自动清理，避免内存泄漏

## 调优建议

### 全局限流

- **保守设置**：设为后端服务总容量的80%
- **监控调整**：根据实际负载情况调整

### 服务限流

- **按服务特性**：重要服务设置更高限制
- **预留余量**：为突发流量预留20-30%余量

### 玩家限流  

- **防止滥用**：设置合理的单玩家请求频率
- **游戏特性**：根据游戏类型调整（实时游戏可适当提高）

## 故障处理

### 误杀正常流量

1. 检查限流配置是否过低
2. 查看监控接口确认令牌桶状态
3. 临时重置对应的限流桶
4. 调整配置文件并重启

### 限流失效

1. 检查 `enabled: true` 配置
2. 确认监控服务正常运行
3. 查看应用启动日志确认限流器初始化

### 性能问题

1. 监控令牌桶数量，避免过多
2. 调整清理间隔和空闲时间
3. 必要时可临时禁用限流

## 最佳实践

1. **分级防护**：全局 > 服务 > 玩家，逐级递减
2. **监控告警**：对接监控系统，设置限流触发告警
3. **动态调整**：根据业务增长及时调整限流参数
4. **测试验证**：上线前进行压力测试验证限流效果 